<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ÄÄƒng nháº­p - SmartRent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="d-flex align-items-center justify-content-center vh-100 bg-light">

<div class="card shadow p-4" style="max-width:400px;width:100%;">
  <h4 class="text-center mb-3 text-danger fw-bold">ÄÄƒng nháº­p SmartRent</h4>

  <input id="loginUser" class="form-control mb-3" placeholder="TÃªn Ä‘Äƒng nháº­p">
  <input id="loginPass" type="password" class="form-control mb-3" placeholder="Máº­t kháº©u">

  <button id="loginSubmit" class="btn btn-danger w-100 mb-2">ÄÄƒng nháº­p</button>

  <a href="./register.html" class="text-center d-block small text-muted">ChÆ°a cÃ³ tÃ i khoáº£n? ÄÄƒng kÃ½</a>

  <p id="loginMsg" class="text-center mt-2 small text-danger"></p>
</div>

<script type="module">
  import { auth, db } from "../js/firebase-config.js";
  import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { ref, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  document.getElementById("loginSubmit").addEventListener("click", async () => {
    const username = loginUser.value.trim();
    const password = loginPass.value.trim();
    const msg = document.getElementById("loginMsg");

    msg.classList.remove("text-danger", "text-success");
    msg.textContent = "";

    if (!username || !password) {
      msg.classList.add("text-danger");
      msg.textContent = "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!";
      return;
    }

    try {
      // ğŸ”¹ Chá»‰ ghÃ©p @ náº¿u chÆ°a cÃ³
      let email = username;
      if (!email.includes("@")) {
        email = email + "@smartrent.local";
      }

      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;

      const snapshot = await get(ref(db, `users/${uid}`));
      const userData = snapshot.val() || {};

      // LÆ°u user
      localStorage.setItem("currentUser", JSON.stringify({
        uid,
        email,
        role: userData.role || "user"
      }));

      // âœ… ThÃ´ng bÃ¡o thÃ nh cÃ´ng
      msg.classList.add("text-success");
      msg.textContent = "ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn vá» trang chá»§...";

      // â³ Chá» 1.2s rá»“i chuyá»ƒn trang
      setTimeout(() => {
        window.location.href = "../index.html";
      }, 1200);

    } catch (err) {
      msg.classList.add("text-danger");
      msg.textContent = "Sai tÃ i khoáº£n hoáº·c máº­t kháº©u!";
      console.error(err);
    }
  });
</script>


</body>
</html>
